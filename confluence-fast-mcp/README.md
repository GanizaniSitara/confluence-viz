# Confluence Fast MCP Server

FastMCP server for serving Confluence data from pickled files. 10-100x faster than live API calls.

Supports 30+ concurrent users for hackathons and team collaboration.

**For hackathons**: See [HACKATHON.md](HACKATHON.md) for quick setup guide.

## Prerequisites

- Python 3.8+
- Pickled Confluence data in `../temp/` (generated by `sample_and_pickle_spaces.py`)

## Installation

```bash
cd confluence-fast-mcp
pip install -r requirements.txt
```

Or install dependencies individually:
```bash
pip install fastmcp whoosh beautifulsoup4 lxml pydantic requests python-dateutil
```

## Configuration

Copy the example settings file and edit if needed:

```bash
cp settings.example.ini settings.ini
```

Default configuration (works if pickles are in `../temp/`):
```ini
[data]
pickle_dir = ../temp
index_dir = ./whoosh_index
```

## Usage

### Option 1: Simple Server (Recommended for Getting Started)

Just loads pickles into memory - instant startup, no indexing required:

```bash
python3 simple_server.py
```

Features:
- Instant startup (loads 80K pages in seconds)
- In-memory title search
- All basic MCP tools work
- No WHOOSH dependency

### Option 2: Full Server with WHOOSH Search

Build search index first (for advanced full-text search):

```bash
python3 build_index.py
PYTHONPATH=$PWD/src python3 -m confluence_fast_mcp.server
```

Features:
- Full-text search with CQL
- Index build required (can take time for large datasets)
- Advanced search capabilities

### Add to Claude Desktop

Add to your MCP settings file:

**macOS**: `~/Library/Application Support/Claude/claude_desktop_config.json`
**Windows**: `%APPDATA%\Claude\claude_desktop_config.json`
**Linux**: `~/.config/Claude/claude_desktop_config.json`

**Simple server** (no indexing):
```json
{
  "mcpServers": {
    "confluence-simple": {
      "command": "/usr/bin/python3",
      "args": ["/home/user/git/confluence-viz/confluence-fast-mcp/simple_server.py"]
    }
  }
}
```

**Full server** (with WHOOSH):
```json
{
  "mcpServers": {
    "confluence-fast": {
      "command": "/usr/bin/python3",
      "args": ["-m", "confluence_fast_mcp.server"],
      "env": {
        "PYTHONPATH": "/home/user/git/confluence-viz/confluence-fast-mcp/src"
      }
    }
  }
}
```

Update paths to match your actual installation.

### Add to Claude Code (CLI)

Claude Code requires HTTP transport. Start the server in HTTP mode:

```bash
# Start server on default port 8070
python3 simple_server.py --http

# Or specify custom port
python3 simple_server.py --http 8080
```

Then edit `~/.claude/mcp_settings.json`:

```bash
mkdir -p ~/.claude
nano ~/.claude/mcp_settings.json
```

Add the HTTP connection:
```json
{
  "mcpServers": {
    "confluence-simple": {
      "url": "http://localhost:8070/sse"
    }
  }
}
```

Save and restart Claude Code. The Confluence tools will be available.

### Restart

Restart Claude Desktop or Claude Code for changes to take effect.

## Available MCP Tools

- `getConfluenceSpaces()` - List all spaces
- `getConfluencePage(pageId)` - Get page with ADF body
- `getPagesInConfluenceSpace(spaceKey)` - List pages in space
- `searchConfluenceUsingCql(cql)` - Search with CQL syntax
- `search(query)` - Simple search
- `fetch(ari)` - Fetch by Atlassian Resource Identifier

## CQL Query Examples

```
text ~ "kubernetes"
space = TECH
title ~ "getting started"
text ~ "api" AND space = DOCS
```

## Rebuilding the Index

If you update your pickle files, rebuild the index:

```bash
python3 build_index.py
```

## Testing

```bash
python3 test_basic.py
```

## Troubleshooting

**"No pickle files found"**
- Run `sample_and_pickle_spaces.py` from parent directory first
- Check `pickle_dir` in `settings.ini` points to correct location

**"Module not found"**
- Install dependencies: `pip install -r requirements.txt`
- Ensure `PYTHONPATH` is set correctly

**"Index not found" / "Index is empty"**
- Run `python3 build_index.py` to create the search index
- This must be done before starting the server

## Performance

- Index building: 10-30s (first run only)
- Search queries: <100ms
- Page retrieval: <10ms
- Speedup: 10-100x vs live API

## Architecture

- `server.py` - FastMCP server with 8 tools
- `indexer.py` - WHOOSH full-text search
- `converters.py` - HTML to ADF conversion
- `search.py` - CQL query parsing
- `pickle_loader.py` - Data loading and caching
- `config.py` - Configuration management
- `models.py` - Response models
- `fallback.py` - Optional live Confluence API client
