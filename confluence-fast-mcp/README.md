# Confluence Fast MCP Server

FastMCP server for serving Confluence data from pickled files. 10-100x faster than live API calls.

## Prerequisites

- Python 3.8+
- Pickled Confluence data in `../temp/` (generated by `sample_and_pickle_spaces.py`)

## Installation

```bash
cd confluence-fast-mcp
pip install -r requirements.txt
```

Or install dependencies individually:
```bash
pip install fastmcp whoosh beautifulsoup4 lxml pydantic requests python-dateutil
```

## Configuration

Edit `settings.ini` if your pickle directory is not `../temp/`:

```ini
[data]
pickle_dir = ../temp
index_dir = ./whoosh_index
```

## Usage

### 1. Build WHOOSH Index (first time only)

```bash
PYTHONPATH=$PWD/src python3 -m confluence_fast_mcp.server
```

The server will automatically build the search index on first run (10-30 seconds). Subsequent starts are instant.

### 2. Add to Claude Desktop

Add to your MCP settings file:

**macOS**: `~/Library/Application Support/Claude/claude_desktop_config.json`
**Windows**: `%APPDATA%\Claude\claude_desktop_config.json`
**Linux**: `~/.config/Claude/claude_desktop_config.json`

```json
{
  "mcpServers": {
    "confluence-fast": {
      "command": "python3",
      "args": ["-m", "confluence_fast_mcp.server"],
      "env": {
        "PYTHONPATH": "/absolute/path/to/confluence-viz/confluence-fast-mcp/src"
      }
    }
  }
}
```

Replace `/absolute/path/to/` with your actual path.

### 3. Restart Claude Desktop

The Confluence tools will now be available in Claude.

## Available MCP Tools

- `getConfluenceSpaces()` - List all spaces
- `getConfluencePage(pageId)` - Get page with ADF body
- `getPagesInConfluenceSpace(spaceKey)` - List pages in space
- `searchConfluenceUsingCql(cql)` - Search with CQL syntax
- `search(query)` - Simple search
- `fetch(ari)` - Fetch by Atlassian Resource Identifier

## CQL Query Examples

```
text ~ "kubernetes"
space = TECH
title ~ "getting started"
text ~ "api" AND space = DOCS
```

## Testing

```bash
python3 test_basic.py
```

## Troubleshooting

**"No pickle files found"**
- Run `sample_and_pickle_spaces.py` from parent directory first
- Check `pickle_dir` in `settings.ini` points to correct location

**"Module not found"**
- Install dependencies: `pip install -r requirements.txt`
- Ensure `PYTHONPATH` is set correctly

**"Index building is slow"**
- First-time indexing takes 10-30 seconds for large datasets
- Subsequent starts use existing index (instant)

## Performance

- Index building: 10-30s (first run only)
- Search queries: <100ms
- Page retrieval: <10ms
- Speedup: 10-100x vs live API

## Architecture

- `server.py` - FastMCP server with 8 tools
- `indexer.py` - WHOOSH full-text search
- `converters.py` - HTML to ADF conversion
- `search.py` - CQL query parsing
- `pickle_loader.py` - Data loading and caching
- `config.py` - Configuration management
- `models.py` - Response models
- `fallback.py` - Optional live Confluence API client
